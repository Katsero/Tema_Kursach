<!-- music/templates/upload.html -->
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Загрузить трек</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f9f9f9;
      }
      .upload-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
        position: relative;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .genre-field {
        display: flex;
        gap: 5px;
        margin-top: 5px;
      }
      .genre-field select {
        flex: 1;
      }
      .remove-genre {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0 8px;
        cursor: pointer;
      }
      .add-genre-btn {
        margin-top: 10px;
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
      .suggestions {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        z-index: 100;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        display: none;
      }
      .suggestions div {
        padding: 8px;
        cursor: pointer;
      }
      .suggestions div:hover {
        background: #f0f0f0;
      }
      button[type="submit"] {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      button[type="submit"]:hover {
        background: #0056b3;
      }
      .messages {
        margin-bottom: 20px;
      }
      .messages li {
        color: green;
        list-style: none;
      }
      a.back {
        display: inline-block;
        margin-top: 20px;
        color: #007bff;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="upload-form">
      <h1>Загрузить трек</h1>

      {% if messages %}
      <ul class="messages">
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <form
        method="post"
        enctype="multipart/form-data"
        id="upload-form"
        data-genres='[ {% for genre in genres %}{"code": "{{ genre.code }}", "name": "{{ genre.name }}"}{% if not forloop.last %}, {% endif %}{% endfor %} ]'
      >
        {% csrf_token %}
        <div class="form-group">
          <label>Ваш ник:</label>
          <input
            type="text"
            name="uploaded_by"
            placeholder="Аноним (по умолчанию)"
            value="{{ form.uploaded_by.value|default:'' }}"
          />
        </div>
        <div class="form-group">
          <label>Название трека:</label>
          <input
            type="text"
            name="title"
            placeholder="Unnamed (по умолчанию)"
            value="{{ form.title.value|default:'' }}"
          />
        </div>
        <div class="form-group">
          <label>Аудиофайл (.mp3/.wav, до 20 МБ):</label>
          {{ form.audio_file }}
        </div>
        <div class="form-group">
          <label>Исполнитель:</label>
          <input
            type="text"
            id="artist-input"
            name="artist_name"
            placeholder="Например: Кипелов"
          />
          <div id="artist-suggestions" class="suggestions"></div>
        </div>
        <div class="form-group">
          <label>Альбом (необязательно):</label>
          <input
            type="text"
            id="album-input"
            name="album_title"
            placeholder="Название альбома"
          />
          <div id="album-suggestions" class="suggestions"></div>
        </div>

        <!-- Жанры -->
        <div class="form-group">
          <label>Жанры:</label>
          <div id="genres-container">
            <!-- Изначально пусто -->
          </div>
          <button type="button" id="add-genre" class="add-genre-btn">
            Добавить жанр
          </button>
        </div>

        <!-- Скрытое поле для отправки жанров -->
        {{ form.genres }}

        <button type="submit">Загрузить трек</button>
      </form>
      <br />
      <a href="{% url 'home' %}" class="back">← Назад на главную</a>
    </div>

    <script>
      // Получаем данные о жанрах из data-атрибута формы
      const allGenres = JSON.parse(
        document.getElementById("upload-form").dataset.genres
      );
      let selectedGenresArray = []; // Массив для хранения кодов выбранных жанров в порядке добавления

      /**
       * Основная функция для рендеринга всех полей жанров
       * Она должна быть единственным источником истины для DOM
       */
      function renderGenres() {
        const container = document.getElementById("genres-container");
        container.innerHTML = ""; // Очищаем контейнер

        // Создаём элементы для каждого выбранного жанра (в порядке массива)
        selectedGenresArray.forEach((code, index) => {
          const genre = allGenres.find((g) => g.code === code);
          if (!genre) return;

          const div = document.createElement("div");
          div.className = "genre-field";

          // Создаём select для этого жанра
          const select = document.createElement("select");
          select.dataset.index = index; // Запоминаем индекс этого жанра в массиве

          // Заполняем select всеми доступными жанрами (кроме уже выбранных)
          allGenres.forEach((g) => {
            if (selectedGenresArray.includes(g.code) && g.code !== code) {
              // Если жанр уже выбран и это не текущий, пропускаем
              return;
            }
            const opt = document.createElement("option");
            opt.value = g.code;
            opt.textContent = g.name;
            if (g.code === code) {
              opt.selected = true; // Выбираем текущий жанр
            }
            select.appendChild(opt);
          });

          // Обработчик изменения значения select
          select.addEventListener("change", () => {
            const oldIndex = parseInt(select.dataset.index); // Индекс жанра в массиве
            const oldCode = selectedGenresArray[oldIndex]; // Старый код жанра
            const newCode = select.value; // Новый код жанра

            // Проверяем, не выбрали ли мы уже существующий жанр (чтобы избежать дубликатов)
            if (selectedGenresArray.includes(newCode)) {
              // Если новый жанр уже есть, просто удаляем старый
              selectedGenresArray.splice(oldIndex, 1);
              // Перерисовываем, чтобы удалить дубликат
              renderGenres();
              return;
            }

            // Обновляем код жанра в массиве по индексу
            selectedGenresArray[oldIndex] = newCode;

            // Перерисовываем всё, чтобы отразить изменения
            renderGenres();
          });

          // Кнопка удаления
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "remove-genre";
          removeBtn.textContent = "✕";
          removeBtn.addEventListener("click", () => {
            // Удаляем жанр из массива по индексу
            selectedGenresArray.splice(index, 1);
            // Перерисовываем
            renderGenres();
          });

          // Добавляем select и кнопку в div
          div.appendChild(select);
          div.appendChild(removeBtn);

          // Добавляем div в контейнер
          container.appendChild(div);
        });

        // Обновляем скрытое поле формы (важно для отправки данных)
        const hiddenSelect = document.querySelector('select[name="genres"]');
        hiddenSelect.innerHTML = "";
        selectedGenresArray.forEach((code) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.selected = true;
          hiddenSelect.appendChild(opt);
        });
      }

      // Функция для добавления нового жанра
      document.getElementById("add-genre").addEventListener("click", () => {
        if (selectedGenresArray.length >= allGenres.length) {
          alert("Нельзя выбрать больше жанров!");
          return;
        }

        // Находим первый доступный жанр (не выбранный)
        const availableGenre = allGenres.find(
          (g) => !selectedGenresArray.includes(g.code)
        );
        if (!availableGenre) {
          alert("Все жанры уже выбраны.");
          return;
        }

        // Добавляем его в конец массива
        selectedGenresArray.push(availableGenre.code);

        // Перерисовываем интерфейс
        renderGenres();
      });

      // Автокомплит (оставляем без изменений)
      function setupAutocomplete(inputId, apiUrl, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        input.addEventListener("input", () => {
          const query = input.value.trim();
          if (query.length < 1) {
            suggestions.style.display = "none";
            return;
          }
          fetch(`${apiUrl}?q=${encodeURIComponent(query)}`)
            .then((r) => r.json())
            .then((data) => {
              suggestions.innerHTML = "";
              data.forEach((item) => {
                const div = document.createElement("div");
                div.textContent = item.name || item.title;
                div.addEventListener("click", () => {
                  input.value = item.name || item.title;
                  suggestions.style.display = "none";
                });
                suggestions.appendChild(div);
              });
              suggestions.style.display = "block";
            });
        });
        document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = "none";
          }
        });
      }

      // Инициализация автокомплита
      document.addEventListener("DOMContentLoaded", () => {
        setupAutocomplete(
          "artist-input",
          "/api/artists/search/",
          "artist-suggestions"
        );
        setupAutocomplete(
          "album-input",
          "/api/albums/search/",
          "album-suggestions"
        );

        // Инициализация рендеринга (если нужно восстановить состояние из формы)
        const hiddenSelect = document.querySelector('select[name="genres"]');
        if (hiddenSelect && hiddenSelect.options.length > 0) {
          for (let i = 0; i < hiddenSelect.options.length; i++) {
            const option = hiddenSelect.options[i];
            if (option.selected) {
              // Добавляем в массив только если его ещё нет (избегаем дубликатов)
              if (!selectedGenresArray.includes(option.value)) {
                selectedGenresArray.push(option.value);
              }
            }
          }
        }

        // Рендерим начальное состояние
        renderGenres();
      });
    </script>
  </body>
</html>
