<!-- music/templates/upload.html -->
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f9f9f9;
      }
      .upload-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
        position: relative;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .genre-field {
        display: flex;
        gap: 5px;
        margin-top: 5px;
      }
      .genre-field select {
        flex: 1;
      }
      .remove-genre {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0 8px;
        cursor: pointer;
      }
      .add-genre-btn {
        margin-top: 10px;
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
      .suggestions {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        z-index: 100;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        display: none;
      }
      .suggestions div {
        padding: 8px;
        cursor: pointer;
      }
      .suggestions div:hover {
        background: #f0f0f0;
      }
      button[type="submit"] {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      button[type="submit"]:hover {
        background: #0056b3;
      }
      .messages {
        margin-bottom: 20px;
      }
      .messages li {
        color: green;
        list-style: none;
      }
      a.back {
        display: inline-block;
        margin-top: 20px;
        color: #007bff;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="upload-form">
      <h1>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</h1>

      {% if messages %}
      <ul class="messages">
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <form
        method="post"
        enctype="multipart/form-data"
        id="upload-form"
        data-genres='[ {% for genre in genres %}{"code": "{{ genre.code }}", "name": "{{ genre.name }}"}{% if not forloop.last %}, {% endif %}{% endfor %} ]'
      >
        {% csrf_token %}
        <div class="form-group">
          <label>–í–∞—à –Ω–∏–∫:</label>
          <input
            type="text"
            name="uploaded_by"
            placeholder="–ê–Ω–æ–Ω–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
            value="{{ form.uploaded_by.value|default:'' }}"
          />
        </div>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞:</label>
          <input
            type="text"
            name="title"
            placeholder="Unnamed (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
            value="{{ form.title.value|default:'' }}"
          />
        </div>
        <div class="form-group">
          <label>–ê—É–¥–∏–æ—Ñ–∞–π–ª (.mp3/.wav, –¥–æ 20 –ú–ë):</label>
          {{ form.audio_file }}
        </div>
        <div class="form-group">
          <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</label>
          <input
            type="text"
            id="artist-input"
            name="artist_name"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏–ø–µ–ª–æ–≤"
          />
          <div id="artist-suggestions" class="suggestions"></div>
        </div>
        <div class="form-group">
          <label>–ê–ª—å–±–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
          <input
            type="text"
            id="album-input"
            name="album_title"
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞"
          />
          <div id="album-suggestions" class="suggestions"></div>
        </div>

        <!-- –ñ–∞–Ω—Ä—ã -->
        <div class="form-group">
          <label>–ñ–∞–Ω—Ä—ã:</label>
          <div id="genres-container">
            <!-- –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ -->
          </div>
          <button type="button" id="add-genre" class="add-genre-btn">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∂–∞–Ω—Ä
          </button>
        </div>

        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–Ω—Ä–æ–≤ -->
        {{ form.genres }}

        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</button>
      </form>
      <br />
      <a href="{% url 'home' %}" class="back">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <script>
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∂–∞–Ω—Ä–∞—Ö –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ —Ñ–æ—Ä–º—ã
      const allGenres = JSON.parse(
        document.getElementById("upload-form").dataset.genres
      );
      let selectedGenresArray = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

      /**
       * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –∂–∞–Ω—Ä–æ–≤
       * –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã –¥–ª—è DOM
       */
      function renderGenres() {
        const container = document.getElementById("genres-container");
        container.innerHTML = ""; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

        // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∂–∞–Ω—Ä–∞ (–≤ –ø–æ—Ä—è–¥–∫–µ –º–∞—Å—Å–∏–≤–∞)
        selectedGenresArray.forEach((code, index) => {
          const genre = allGenres.find((g) => g.code === code);
          if (!genre) return;

          const div = document.createElement("div");
          div.className = "genre-field";

          // –°–æ–∑–¥–∞—ë–º select –¥–ª—è —ç—Ç–æ–≥–æ –∂–∞–Ω—Ä–∞
          const select = document.createElement("select");
          select.dataset.index = index; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ –∂–∞–Ω—Ä–∞ –≤ –º–∞—Å—Å–∏–≤–µ

          // –ó–∞–ø–æ–ª–Ω—è–µ–º select –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∂–∞–Ω—Ä–∞–º–∏ (–∫—Ä–æ–º–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö)
          allGenres.forEach((g) => {
            if (selectedGenresArray.includes(g.code) && g.code !== code) {
              // –ï—Å–ª–∏ –∂–∞–Ω—Ä —É–∂–µ –≤—ã–±—Ä–∞–Ω –∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
              return;
            }
            const opt = document.createElement("option");
            opt.value = g.code;
            opt.textContent = g.name;
            if (g.code === code) {
              opt.selected = true; // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π –∂–∞–Ω—Ä
            }
            select.appendChild(opt);
          });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è select
          select.addEventListener("change", () => {
            const oldIndex = parseInt(select.dataset.index); // –ò–Ω–¥–µ–∫—Å –∂–∞–Ω—Ä–∞ –≤ –º–∞—Å—Å–∏–≤–µ
            const oldCode = selectedGenresArray[oldIndex]; // –°—Ç–∞—Ä—ã–π –∫–æ–¥ –∂–∞–Ω—Ä–∞
            const newCode = select.value; // –ù–æ–≤—ã–π –∫–æ–¥ –∂–∞–Ω—Ä–∞

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∂–∞–Ω—Ä (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
            if (selectedGenresArray.includes(newCode)) {
              // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –∂–∞–Ω—Ä —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π
              selectedGenresArray.splice(oldIndex, 1);
              // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
              renderGenres();
              return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∂–∞–Ω—Ä–∞ –≤ –º–∞—Å—Å–∏–≤–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É
            selectedGenresArray[oldIndex] = newCode;

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—ë, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            renderGenres();
          });

          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "remove-genre";
          removeBtn.textContent = "‚úï";
          removeBtn.addEventListener("click", () => {
            // –£–¥–∞–ª—è–µ–º –∂–∞–Ω—Ä –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
            selectedGenresArray.splice(index, 1);
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
            renderGenres();
          });

          // –î–æ–±–∞–≤–ª—è–µ–º select –∏ –∫–Ω–æ–ø–∫—É –≤ div
          div.appendChild(select);
          div.appendChild(removeBtn);

          // –î–æ–±–∞–≤–ª—è–µ–º div –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          container.appendChild(div);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã (–≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
        const hiddenSelect = document.querySelector('select[name="genres"]');
        hiddenSelect.innerHTML = "";
        selectedGenresArray.forEach((code) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.selected = true;
          hiddenSelect.appendChild(opt);
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∂–∞–Ω—Ä–∞
      document.getElementById("add-genre").addEventListener("click", () => {
        if (selectedGenresArray.length >= allGenres.length) {
          alert("–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ –∂–∞–Ω—Ä–æ–≤!");
          return;
        }

        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∂–∞–Ω—Ä (–Ω–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π)
        const availableGenre = allGenres.find(
          (g) => !selectedGenresArray.includes(g.code)
        );
        if (!availableGenre) {
          alert("–í—Å–µ –∂–∞–Ω—Ä—ã —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã.");
          return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞
        selectedGenresArray.push(availableGenre.code);

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        renderGenres();
      });

      // –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      function setupAutocomplete(inputId, apiUrl, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        input.addEventListener("input", () => {
          const query = input.value.trim();
          if (query.length < 1) {
            suggestions.style.display = "none";
            return;
          }
          fetch(`${apiUrl}?q=${encodeURIComponent(query)}`)
            .then((r) => r.json())
            .then((data) => {
              suggestions.innerHTML = "";
              data.forEach((item) => {
                const div = document.createElement("div");
                div.textContent = item.name || item.title;
                div.addEventListener("click", () => {
                  input.value = item.name || item.title;
                  suggestions.style.display = "none";
                });
                suggestions.appendChild(div);
              });
              suggestions.style.display = "block";
            });
        });
        document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = "none";
          }
        });
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
      document.addEventListener("DOMContentLoaded", () => {
        setupAutocomplete(
          "artist-input",
          "/api/artists/search/",
          "artist-suggestions"
        );
        setupAutocomplete(
          "album-input",
          "/api/albums/search/",
          "album-suggestions"
        );

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ñ–æ—Ä–º—ã)
        const hiddenSelect = document.querySelector('select[name="genres"]');
        if (hiddenSelect && hiddenSelect.options.length > 0) {
          for (let i = 0; i < hiddenSelect.options.length; i++) {
            const option = hiddenSelect.options[i];
            if (option.selected) {
              // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç (–∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
              if (!selectedGenresArray.includes(option.value)) {
                selectedGenresArray.push(option.value);
              }
            }
          }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        renderGenres();
      });
    </script>
  </body>
</html>
