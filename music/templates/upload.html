<!-- music/templates/upload.html -->
{% extends "base.html" %}
{% block title %}Загрузить трек{% endblock %}
{% block extra_css %}
<style>
  .upload-form {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    margin: 0 auto;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .form-group {
    margin-bottom: 15px;
    position: relative;
  }
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  input,
  select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .artist-field,
  .genre-field {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    position: relative; 
  }
  .artist-field input,
  .genre-field select {
    flex: 1;
  }
  .remove-artist,
  .remove-genre {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0 8px;
    cursor: pointer;
    font-size: 14px;
  }
  .add-artist-btn,
  .add-genre-btn {
    margin-top: 10px;
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ccc;
    z-index: 1000;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    border-top: none;
    border-bottom-left-radius: 6px;
    border-bottom-right-radius: 6px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
  }
  .suggestions div {
    padding: 8px 14px;
    cursor: pointer;
    font-size: 15px;
  }
  .suggestions div:hover {
    background: #e9ecef;
  }
  button[type="submit"] {
    background: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
    font-size: 16px;
  }
  button[type="submit"]:hover {
    background: #0056b3;
  }
  .error-messages {
    color: red;
    background: #f8d7da;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
  }
  .error-messages ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  a.back {
    display: inline-block;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
  }
</style>
{% endblock %}
{% block content %}
<div class="upload-form">
  <h1>Загрузить трек</h1>

  {% if form.errors %}
    <div class="error-messages">
      <p><strong>Ошибки в форме:</strong></p>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form
    method="post"
    enctype="multipart/form-data"
    id="upload-form"
    data-genres='[ {% for genre in genres %}{"code": "{{ genre.code }}", "name": "{{ genre.name }}"}{% if not forloop.last %}, {% endif %}{% endfor %} ]'
  >
    {% csrf_token %}
    <div class="form-group">
      <label>Ваш ник:</label>
      <input
        type="text"
        name="uploaded_by"
        placeholder="Аноним (по умолчанию)"
        value="{{ form.uploaded_by.value|default:'' }}"
      />
    </div>
    <div class="form-group">
      <label>Название трека:</label>
      <input
        type="text"
        name="title"
        placeholder="Unnamed (по умолчанию)"
        value="{{ form.title.value|default:'' }}"
      />
    </div>
    <div class="form-group">
      <label>Аудиофайл (.mp3/.wav, до 20 МБ):</label>
      {{ form.audio_file }}
    </div>

    <div class="form-group">
      <label>Исполнители:</label>
      <div id="artists-container">
      </div>
      <button type="button" id="add-artist" class="add-artist-btn">
        Добавить исполнителя
      </button>
    </div>

    <div class="form-group">
      <label>Альбом (необязательно):</label>
      <input
        type="text"
        id="album-input"
        name="album_title"
        placeholder="Название альбома"
      />
      <div id="album-suggestions" class="suggestions"></div>
    </div>

    <div class="form-group">
      <label>Жанры:</label>
      <div id="genres-container">
      </div>
      <button type="button" id="add-genre" class="add-genre-btn">
        Добавить жанр
      </button>
    </div>

    <input type="hidden" name="artist_names" id="artist-names-hidden" />
    <div id="genres-hidden-container"></div>

    <button type="submit">Загрузить трек</button>
  </form>
  <a href="{% url 'home' %}" class="back">← Назад на главную</a>
</div>

<script>
  const allGenres = JSON.parse(
    document.getElementById("upload-form").dataset.genres
  );
  let selectedGenresArray = [];

  function renderGenres() {
    const container = document.getElementById("genres-container");
    container.innerHTML = "";

    selectedGenresArray.forEach((code, index) => {
      const genre = allGenres.find((g) => g.code === code);
      if (!genre) return;

      const div = document.createElement("div");
      div.className = "genre-field";

      const select = document.createElement("select");
      select.dataset.index = index;

      allGenres.forEach((g) => {
        if (selectedGenresArray.includes(g.code) && g.code !== code) return;
        const opt = document.createElement("option");
        opt.value = g.code;
        opt.textContent = g.name;
        if (g.code === code) opt.selected = true;
        select.appendChild(opt);
      });

      select.addEventListener("change", () => {
        const oldIndex = parseInt(select.dataset.index);
        const oldCode = selectedGenresArray[oldIndex];
        const newCode = select.value;

        if (selectedGenresArray.includes(newCode)) {
          selectedGenresArray.splice(oldIndex, 1);
          renderGenres();
          return;
        }

        selectedGenresArray[oldIndex] = newCode;
        renderGenres();
      });

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "remove-genre";
      removeBtn.textContent = "✕";
      removeBtn.addEventListener("click", () => {
        selectedGenresArray.splice(index, 1);
        renderGenres();
      });

      div.appendChild(select);
      div.appendChild(removeBtn);
      container.appendChild(div);
    });

    const hiddenContainer = document.getElementById('genres-hidden-container');
    hiddenContainer.innerHTML = "";
    selectedGenresArray.forEach((code) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "genres";
      input.value = code;
      hiddenContainer.appendChild(input);
    });
  }

  document.getElementById("add-genre").addEventListener("click", () => {
    if (selectedGenresArray.length >= allGenres.length) {
      alert("Нельзя выбрать больше жанров!");
      return;
    }
    const availableGenre = allGenres.find((g) => !selectedGenresArray.includes(g.code));
    if (!availableGenre) {
      alert("Все жанры уже выбраны.");
      return;
    }
    selectedGenresArray.push(availableGenre.code);
    renderGenres();
  });

  let artistFieldCounter = 1;

  function createArtistField(value = '') {
    const container = document.getElementById("artists-container");
    const wrapper = document.createElement("div");
    wrapper.className = "artist-field";

    const input = document.createElement("input");
    input.type = "text";
    input.className = "artist-input";
    input.placeholder = "Например: Кипелов";
    input.value = value;

    const inputId = `artist-input-${artistFieldCounter++}`;
    input.id = inputId;

    const suggestions = document.createElement("div");
    suggestions.className = "artist-suggestions suggestions";
    suggestions.id = `suggestions-${inputId}`;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "remove-artist";
    removeBtn.textContent = "✕";
    removeBtn.addEventListener("click", () => {
      wrapper.remove();
      updateArtistHiddenInput();
    });

    wrapper.appendChild(input);
    wrapper.appendChild(suggestions);
    wrapper.appendChild(removeBtn);

    container.appendChild(wrapper);

    setupAutocomplete(inputId, "/api/artists/search/", suggestions.id);
  }

  function updateArtistHiddenInput() {
    const inputs = document.querySelectorAll(".artist-input");
    const names = Array.from(inputs)
      .map(input => input.value.trim())
      .filter(name => name);
    document.getElementById("artist-names-hidden").value = names.join("|");
  }

  document.getElementById("add-artist").addEventListener("click", () => {
    createArtistField();
  });

  function setupAutocomplete(inputId, apiUrl, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    if (!input || !suggestions) return;

    input.removeEventListener("input", handleInput);
    suggestions.removeEventListener("click", handleClickOutside);

    function handleInput() {
      const query = input.value.trim();
      if (query.length < 1) {
        suggestions.style.display = "none";
        return;
      }
      fetch(`${apiUrl}?q=${encodeURIComponent(query)}`)
        .then((r) => r.json())
        .then((data) => {
          suggestions.innerHTML = "";
          data.forEach((item) => {
            const div = document.createElement("div");
            div.textContent = item.name || item.title;
            div.addEventListener("click", () => {
              input.value = item.name || item.title;
              suggestions.style.display = "none";
              updateArtistHiddenInput();
            });
            suggestions.appendChild(div);
          });
          suggestions.style.display = "block";
        });
    }

    function handleClickOutside(e) {
      if (!input.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.style.display = "none";
      }
    }

    input.addEventListener("input", handleInput);
    document.addEventListener("click", handleClickOutside);

    input.addEventListener("focus", () => {
      suggestions.style.display = "none";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupAutocomplete("album-input", "/api/albums/search/", "album-suggestions");

    const hiddenContainer = document.getElementById('genres-hidden-container');
    if (hiddenContainer) {
      const inputs = hiddenContainer.querySelectorAll('input[name="genres"]');
      inputs.forEach((input) => {
        if (input.value && !selectedGenresArray.includes(input.value)) {
          selectedGenresArray.push(input.value);
        }
      });
      renderGenres();
    }

    document.addEventListener("input", (e) => {
      if (e.target.classList.contains("artist-input")) {
        updateArtistHiddenInput();
      }
    });
  });
</script>
{% endblock %}